<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å¤ªé™½é ˜è¢–ç‡Ÿ - äº’å‹•æ¶ç­”å¤§è³½</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #6c5ce7; --accent: #fdcb6e; --danger: #ff7675; --success: #55efc4; --dark: #2d3436; --sun: #f39c12; }
        body { margin: 0; font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: radial-gradient(circle, #ff9f43 0%, #ee5253 100%); color: white; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 10px 0; }
        
        .header-container { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 25px; width: 100%; text-align: center; }
        .event-logo { width: 120px; height: 120px; object-fit: contain; background: white; border-radius: 50%; padding: 5px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .main-title { font-size: 2.8rem; font-weight: 900; color: #fff; text-shadow: 4px 4px 0px var(--sun); margin: 10px 0; }

        .card { background: white; color: var(--dark); width: 88%; max-width: 450px; padding: 25px; border-radius: 25px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.3); position: relative; }
        .hidden { display: none !important; }
        
        input, select { width: 90%; padding: 14px; font-size: 1.1rem; margin: 8px 0; border: 2px solid #dfe6e9; border-radius: 12px; text-align: center; }
        button { width: 95%; padding: 14px; font-size: 1.1rem; margin: 8px 0; background: var(--accent); color: #d35400; border: none; border-radius: 40px; font-weight: bold; cursor: pointer; box-shadow: 0 5px 0 #e67e22; }
        button:active { transform: translateY(3px); box-shadow: 0 2px 0 #e67e22; }
        
        .instruction-box { text-align: left; background: #fff9e6; padding: 15px; border-radius: 12px; margin-bottom: 15px; font-size: 1rem; line-height: 1.6; color: #636e72; border: 1px dashed var(--sun); }
        .q-box { font-size: 1.5rem; margin: 15px 0; padding: 20px; background: #f1f2f6; border-radius: 15px; font-weight: bold; min-height: 80px; display: flex; align-items: center; justify-content: center; }
        .timer-badge { font-size: 3.2rem; color: var(--danger); font-weight: bold; margin: 5px 0; }
        .opt-btn { background: #f8f9fa; color: var(--dark); box-shadow: 0 4px 0 #ced4da; margin: 8px 0; }
        
        .host-tools { position: fixed; bottom: 15px; right: 15px; display: flex; flex-direction: column; gap: 8px; z-index: 1000; }
        .btn-sm { font-size: 0.8rem; padding: 10px; width: 110px; background: #2d3436; color: white; border-radius: 10px; box-shadow: 0 3px 0 #000; }
    </style>
</head>
<body>

<div class="header-container">
    <img src="logo.png" alt="LOGO" class="event-logo" onerror="this.style.display='none'">
    <h1 class="main-title">â˜€ï¸ å°å¤ªé™½é ˜è¢–ç‡Ÿ</h1>
</div>

<div class="card">
    <div id="view-login">
        <h2 id="login-title">æº–å‚™å¥½æ¶ç­”äº†å—ï¼Ÿ</h2>
        <input id="login-input" placeholder="è«‹è¼¸å…¥éšŠä¼åç¨±">
        <button id="btn-join">ä¸‹ä¸€é  â”</button>
    </div>

    <div id="view-setup" class="hidden">
        <h3 style="color:var(--sun)">âš™ï¸ éŠæˆ²è¨­å®š</h3>
        <p>æŠ½å–é¡Œæ•¸ï¼š<input type="number" id="q-count" value="10"></p>
        <p>æ¯é¡Œç§’æ•¸ï¼š<input type="number" id="q-timer" value="15"></p>
        <button id="btn-to-instruction">å‰å¾€èªªæ˜é </button>
    </div>

    <div id="view-instruction" class="hidden">
        <h3 style="color:var(--sun)">ğŸ“– éŠæˆ²è¦å‰‡</h3>
        <div class="instruction-box">
            â˜€ï¸ æ¡ã€Œ<b>å…¨é«”æ¶ç­”</b>ã€ï¼Œå…ˆç­”å°è€…ç²å‹ã€‚<br>
            â˜€ï¸ ç­”éŒ¯æœƒéœ‡å‹•ä¸¦å¤±å»è©²é¡Œæ©Ÿæœƒã€‚<br>
            â˜€ï¸ å€’æ•¸æœ€å¾Œä¸‰ç§’è«‹æ³¨æ„è­¦ç¤ºéŸ³ï¼
        </div>
        <img id="qr-display" src="" alt="QR" style="width:150px; margin:10px auto; display:block;" onerror="this.src='https://api.qrserver.com/v1/create-qr-code/?size=200x200&data='+encodeURIComponent(window.location.href.split('?')[0])">
        <div id="host-start-area" class="hidden">
            <button id="btn-real-start" style="background:var(--success); color:#006266;">ğŸ® é–‹å§‹éŠæˆ²</button>
        </div>
        <p id="wait-msg">âŒ› ç­‰å¾…ä¸»æŒäººå•Ÿå‹•éŠæˆ²...</p>
    </div>

    <div id="view-game" class="hidden">
        <div id="q-header" style="font-size:0.9rem; color:#636e72;"></div>
        <div id="timer-display" class="timer-badge">--</div>
        <div id="q-content" class="q-box"></div>
        <div id="player-zone" class="hidden"><div id="options-area"></div><p id="feedback" style="min-height:1.2em; font-weight:bold;"></p></div>
        <div id="win-notification" class="hidden"><div style="background:var(--success); color:#006266; padding:15px; border-radius:15px; font-weight:bold;">ğŸ‰ <span id="win-player-name"></span> æ¶ç­”æˆåŠŸï¼</div></div>
        <div id="ans-reveal" class="hidden" style="background:#fff3cd; padding:15px; border-radius:20px; margin-top:10px; border:1px solid #ffeeba;"><h3 style="margin:0;">æ­£è§£ï¼š<span id="correct-ans"></span></h3></div>
        <div id="host-actions" class="hidden"><button id="btn-reveal">æ­æ›‰ç­”æ¡ˆ</button><button id="btn-next" class="hidden">ä¸‹ä¸€é¡Œ â”</button></div>
    </div>

    <div id="view-result" class="hidden">
        <h2 style="color:var(--sun)">ğŸ† æ¦®è­½æ’è¡Œæ¦œ</h2>
        <table style="width:100%; border-collapse: collapse;"><tbody id="leaderboard-body"></tbody></table>
        <div id="host-reset-area" class="hidden"><button id="btn-finish-reset" style="background:#bdc3c7; color:white; margin-top:20px;">ğŸ”„ çµæŸä¸¦é‡ç½®</button></div>
    </div>

    <div id="view-admin-qs" class="hidden">
        <h3 style="color:var(--primary)">ğŸ“š é¡Œåº«ç¶­è­·</h3>
        <select id="new-q-type"><option value="choice">é¸æ“‡é¡Œ</option><option value="tf">æ˜¯éé¡Œ</option></select>
        <input id="new-q-text" placeholder="é¡Œç›®å…§å®¹">
        <input id="new-q-opts" placeholder="é¸é … (å¦‚ A:æ˜¯,B:å¦ æˆ– O,X)">
        <input id="new-q-ans" placeholder="ç­”æ¡ˆ (A æˆ– O)">
        <button id="btn-add-q">æ–°å¢</button>
        <div id="qs-list" style="max-height:150px; overflow-y:auto; text-align:left; margin:10px 0; font-size:0.85rem; background:#f8f9fa; padding:10px;"></div>
        <button id="btn-back-game" style="background:var(--dark); color:white;">è¿”å›</button>
    </div>
</div>

<div id="host-global-tools" class="host-tools hidden">
    <button id="btn-admin-qs-link" class="btn-sm">é¡Œåº«ç®¡ç†</button>
    <button id="btn-hard-reset" class="btn-sm" style="background:var(--danger); color:white;">å…¨é¢é‡ç½®</button>
</div>

<script>
/* ========= éŸ³æ•ˆå®šç¾© ========= */
const soundCorrect = new Audio('correct.mp3');
const soundWrong = new Audio('wrong.mp3');
const soundBeep = new Audio('beep.mp3');

function unlockAudio() {
    [soundCorrect, soundWrong, soundBeep].forEach(s => { s.play().then(()=> {s.pause(); s.currentTime=0;}).catch(()=>{}); });
}

/* ========= Firebase Config ========= */
const firebaseConfig = {
    apiKey: "AIzaSyAMvRegqD33yBy6mcCl3sB9IK8efeECxHk",
    authDomain: "exam-questions-1eb01.firebaseapp.com",
    databaseURL: "https://exam-questions-1eb01-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "exam-questions-1eb01",
    storageBucket: "exam-questions-1eb01.firebasestorage.app",
    messagingSenderId: "826696852167",
    appId: "1:826696852167:web:3001addfd34e8d91d714e2"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ========= æ ¸å¿ƒç‹€æ…‹æ§åˆ¶ ========= */
const isHost = window.location.search.includes('host=true');
let myName = "";
let localQuestions = [];
let timerInterval = null;

const loginTitle = document.getElementById('login-title');
const loginInput = document.getElementById('login-input');

// æ ¹æ“šæ¬Šé™åˆå§‹åŒ– UI
if(isHost) {
    loginTitle.innerText = "ğŸ”‘ ç®¡ç†å“¡ç™»å…¥";
    loginInput.placeholder = "è«‹è¼¸å…¥ä¸»æŒäººå¯†ç¢¼";
    loginInput.type = "password";
}

function show(id) {
    document.querySelectorAll('.card > div').forEach(v => v.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
}

// ç™»å…¥æŒ‰éˆ•
document.getElementById('btn-join').onclick = () => {
    unlockAudio();
    const val = loginInput.value.trim();
    if(!val) return alert("ä¸å¯ç©ºç™½");

    if(isHost) {
        if(val === "00000") {
            myName = "ç®¡ç†å“¡";
            show('view-setup');
            document.getElementById('host-global-tools').classList.remove('hidden');
        } else {
            alert("ä¸»æŒäººå¯†ç¢¼éŒ¯èª¤");
        }
    } else {
        myName = val;
        show('view-instruction');
    }
};

/* ========= éŠæˆ²é‚è¼¯ ========= */

function submitAns(ans) {
    db.ref('game').once('value', snap => {
        const g = snap.val();
        if(!g || g.winner || g.timeLeft <= 0) return;
        const correct = g.qs[g.idx].answer.trim().toUpperCase();
        if(ans.trim().toUpperCase() === correct){
            soundCorrect.play();
            db.ref('game/winner').set(myName);
            db.ref('players/' + myName).transaction(s => (s || 0) + 10);
        } else {
            soundWrong.play();
            if (navigator.vibrate) navigator.vibrate(200); // ç­”éŒ¯éœ‡å‹•
            document.getElementById('feedback').innerText = "âŒ ç­”éŒ¯äº†ï¼";
            setTimeout(()=> document.getElementById('feedback').innerText="", 1000);
        }
    });
}

// ç›£è½åŒæ­¥
db.ref('game').on('value', snap => {
    const g = snap.val();
    if(!g) return;

    if(g.status === 'playing') {
        show('view-game');
        const cur = g.qs[g.idx];
        document.getElementById('q-content').innerText = cur.question;
        document.getElementById('timer-display').innerText = g.timeLeft;
        
        // å€’æ•¸éŸ³æ•ˆ
        if (g.timeLeft > 0 && g.timeLeft <= 3 && !g.winner) soundBeep.play();

        const area = document.getElementById('options-area');
        area.innerHTML = "";
        cur.options.split(',').forEach(o => {
            const btn = document.createElement('button');
            btn.className = "opt-btn";
            btn.innerText = o;
            btn.onclick = () => submitAns(o.includes(':') ? o.split(':')[0] : o);
            area.appendChild(btn);
        });

        if(g.winner) {
            clearInterval(timerInterval); timerInterval = null;
            document.getElementById('player-zone').classList.add('hidden');
            document.getElementById('win-notification').classList.remove('hidden');
            document.getElementById('win-player-name').innerText = g.winner;
            if(isHost) {
                document.getElementById('host-actions').classList.remove('hidden');
                document.getElementById('btn-next').classList.toggle('hidden', !g.show);
            }
            if(g.show) {
                document.getElementById('ans-reveal').classList.remove('hidden');
                document.getElementById('correct-ans').innerText = cur.answer;
            }
        } else if(g.timeLeft <= 0) {
            clearInterval(timerInterval); timerInterval = null;
            document.getElementById('player-zone').classList.add('hidden');
            document.getElementById('q-content').innerText = "âŒ› æ™‚é–“åˆ°ï¼";
            if(isHost) document.getElementById('host-actions').classList.remove('hidden');
            if(g.show) {
                document.getElementById('ans-reveal').classList.remove('hidden');
                document.getElementById('correct-ans').innerText = cur.answer;
            }
        } else {
            if(!isHost) document.getElementById('player-zone').classList.remove('hidden');
            document.getElementById('win-notification').classList.add('hidden');
            document.getElementById('ans-reveal').classList.add('hidden');
            document.getElementById('host-actions').classList.add('hidden');
        }

        if(isHost && !g.winner && g.timeLeft > 0 && !timerInterval) {
            timerInterval = setInterval(() => {
                db.ref('game/timeLeft').transaction(t => (t > 0 ? t - 1 : 0));
            }, 1000);
        }
    } else if(g.status === 'finished') {
        show('view-result');
        if(isHost) document.getElementById('host-reset-area').classList.remove('hidden');
        db.ref('players').once('value', pSnap => {
            const ps = pSnap.val() || {};
            let list = Object.keys(ps).map(k => ({n:k, s:ps[k]})).sort((a,b)=>b.s-a.s);
            document.getElementById('leaderboard-body').innerHTML = list.map((p,i)=>
                `<tr style="border-bottom:1px solid #eee;"><td style="padding:10px">${i+1}</td><td>${p.n}</td><td>${p.s}åˆ†</td></tr>`
            ).join('');
        });
    }
});

/* ========= ç®¡ç†æ§åˆ¶åŠŸèƒ½ ========= */
document.getElementById('btn-to-instruction').onclick = () => {
    show('view-instruction');
    if(isHost) {
        document.getElementById('host-start-area').classList.remove('hidden');
        document.getElementById('wait-msg').classList.add('hidden');
    }
};

document.getElementById('btn-real-start').onclick = () => {
    db.ref('questions').once('value', s => {
        const all = Object.values(s.val() || {});
        if(all.length === 0) return alert("é¡Œåº«æ²’é¡Œç›®");
        const count = parseInt(document.getElementById('q-count').value);
        const timer = parseInt(document.getElementById('q-timer').value);
        db.ref('game').set({ status: 'playing', qs: all.slice(0, count), idx: 0, winner: "", show: false, timeLeft: timer, maxTime: timer });
    });
};

document.getElementById('btn-reveal').onclick = () => db.ref('game/show').set(true);
document.getElementById('btn-next').onclick = () => {
    db.ref('game').once('value', snap => {
        const g = snap.val();
        if(g.idx + 1 < g.qs.length) db.ref('game').update({ idx: g.idx + 1, winner: "", show: false, timeLeft: g.maxTime });
        else db.ref('game/status').set('finished');
    });
};

document.getElementById('btn-admin-qs-link').onclick = () => show('view-admin-qs');
document.getElementById('btn-back-game').onclick = () => location.reload();
document.getElementById('btn-add-q').onclick = () => {
    const type = document.getElementById('new-q-type').value;
    const question = document.getElementById('new-q-text').value;
    const options = document.getElementById('new-q-opts').value;
    const answer = document.getElementById('new-q-ans').value;
    if(question && answer) {
        db.ref('questions').push({type, question, options, answer});
        alert("æ–°å¢æˆåŠŸ");
    }
};

db.ref('questions').on('value', snap => {
    let html = "";
    for(let id in snap.val()) { html += `<div>â€¢ ${snap.val()[id].question}</div>`; }
    document.getElementById('qs-list').innerHTML = html;
});

document.getElementById('btn-hard-reset').onclick = () => { if(confirm("ç¢ºå®šå…¨é¢é‡ç½®ï¼Ÿ")) { db.ref('game').remove(); db.ref('players').remove(); location.reload(); } };
document.getElementById('btn-finish-reset').onclick = () => { db.ref('game').remove(); db.ref('players').remove(); location.reload(); };

</script>
</body>
</html>