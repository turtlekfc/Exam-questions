<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>äº’å‹•æ¶ç­”å¤§è³½ Pro+</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<style>
:root {
    --primary:#6c5ce7;
    --accent:#fdcb6e;
    --danger:#ff7675;
    --success:#55efc4;
    --dark:#2d3436;
}

* {
    -webkit-tap-highlight-color: transparent;
}

body {
    font-family: 'PingFang TC','Microsoft JhengHei',sans-serif;
    background: radial-gradient(circle,#6c5ce7 0%,#4834d4 100%);
    color:white;
    margin:0;
    padding:10px 0;
    display:flex;
    flex-direction:column;
    align-items:center;
    min-height:100vh;
    touch-action:manipulation;
}

/* ===== Header + Logo ===== */
.header-container {
    width:100%;
    display:flex;
    justify-content:center;
    margin-bottom:15px;
}
.title-wrap {
    display:flex;
    align-items:center;
    gap:10px;
}
.event-logo {
    height:48px;
}
.event-title {
    font-size:clamp(1.2rem,5.5vw,2.5rem);
    font-weight:900;
    color:var(--accent);
    text-shadow:2px 2px 0 #d35400;
    white-space:nowrap;
}

/* ===== Card ===== */
.card {
    background:white;
    color:var(--dark);
    padding:20px;
    border-radius:25px;
    width:88%;
    max-width:450px;
    box-shadow:0 15px 35px rgba(0,0,0,.3);
    text-align:center;
}

.hidden { display:none!important; }

.q-box {
    background:#f1f2f6;
    padding:15px;
    border-radius:15px;
    font-weight:bold;
    font-size:1.4rem;
    min-height:80px;
    display:flex;
    align-items:center;
    justify-content:center;
}

.timer-badge {
    font-size:2rem;
    font-weight:bold;
    color:var(--danger);
}

input,select {
    width:90%;
    padding:12px;
    font-size:1rem;
    border-radius:10px;
    border:2px solid #dfe6e9;
    margin:8px 0;
    text-align:center;
}

button {
    background:var(--accent);
    color:#d35400;
    border:none;
    padding:14px;
    font-size:1.1rem;
    border-radius:50px;
    font-weight:900;
    cursor:pointer;
    margin:6px;
}

.opt-btn {
    width:100%;
    background:#eee;
    color:var(--dark);
    margin:6px 0;
    min-height:56px;
}

/* ===== Host tools ===== */
.host-fixed-tools {
    position:fixed;
    right:20px;
    bottom:20px;
    background:rgba(0,0,0,.95);
    padding:15px;
    border-radius:20px;
    z-index:999;
    display:flex;
    flex-direction:column;
    gap:10px;
}

/* ===== Responsive ===== */
@media(max-width:768px){
    button{font-size:1.2rem;padding:16px}
    .card{width:94%}
    .event-logo{height:36px}
}
@media(min-width:768px){
    .card{max-width:520px}
}
</style>
</head>

<body>

<!-- ===== Header ===== -->
<div class="header-container">
    <div class="title-wrap">
        <img src="logo.png" class="event-logo">
        <div class="event-title">å°å¤ªé™½é ˜è¢–ç‡Ÿ</div>
    </div>
</div>

<!-- ===== Host Tools ===== -->
<div id="host-tools" class="host-fixed-tools hidden">
    <span style="font-size:.8rem">ğŸ‘‘ ç®¡ç†å“¡</span>
    <button onclick="location.reload()">é‡æ–°æ•´ç†</button>
</div>

<div class="card">

<!-- ===== Login ===== -->
<div id="view-login">
    <h2 style="color:var(--primary)">æº–å‚™å¥½æ¶ç­”äº†å—ï¼Ÿ</h2>
    <input id="username" placeholder="å§“å / éšŠä¼">
    <button id="btn-join">é€²å…¥</button>
</div>

<!-- ===== Instruction ===== -->
<div id="view-instruction" class="hidden">
    <h2 style="color:var(--primary)">éŠæˆ²èªªæ˜</h2>
    <p style="line-height:1.8;text-align:left">
        â€¢ å…¨é«”åŒæ™‚æ¶ç­”<br>
        â€¢ ç¬¬ä¸€å€‹ç­”å°å³å¾—åˆ†<br>
        â€¢ æ¯é¡Œåªèƒ½ç­”ä¸€æ¬¡
    </p>
    <p>ç­‰å¾…ä¸»æŒäººé–‹å§‹â€¦</p>
</div>

<!-- ===== Game ===== -->
<div id="view-game" class="hidden">
    <div id="q-header"></div>
    <div id="timer" class="timer-badge"></div>
    <div id="q-content" class="q-box"></div>
    <div id="options"></div>
    <p id="feedback" style="color:var(--danger);font-weight:bold"></p>
</div>

<!-- ===== Result ===== -->
<div id="view-result" class="hidden">
    <h2 style="color:var(--primary)">ğŸ† æ’è¡Œæ¦œ</h2>
    <div id="result-list"></div>
</div>

</div>

<script>
/* ===== Firebase ===== */
firebase.initializeApp({
    apiKey:"AIzaSyAMvRegqD33yBy6mcCl3sB9IK8efeECxHk",
    databaseURL:"https://exam-questions-1eb01-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db = firebase.database();

/* ===== State ===== */
const isHost = location.search.includes('host=true');
let myName="";
let lastIdx=null;
let timerInterval=null;

/* ===== View ===== */
const go=v=>{
    document.querySelectorAll('.card>div').forEach(d=>d.classList.add('hidden'));
    document.getElementById(v).classList.remove('hidden');
};

/* ===== Login ===== */
document.getElementById('btn-join').onclick=()=>{
    const v=username.value.trim();
    if(!v)return alert("è«‹è¼¸å…¥åç¨±");
    myName=v;
    go('view-instruction');
};

/* ===== Game Listener ===== */
db.ref('game').on('value',snap=>{
    const g=snap.val();
    if(!g)return;

    if(g.status==='playing'){
        go('view-game');
        const q=g.qs[g.idx];
        q-header.innerText=`ç¬¬ ${g.idx+1} é¡Œ / ${g.qs.length}`;
        q-content.innerText=q.question;

        if(g.idx!==lastIdx){
            lastIdx=g.idx;
            options.innerHTML="";
            q.options.split(',').forEach(o=>{
                const b=document.createElement('button');
                b.className='opt-btn';
                b.innerText=o;
                b.onclick=()=>{
                    b.disabled=true;
                    submit(o.includes(':')?o.split(':')[0]:o);
                };
                options.appendChild(b);
            });
        }

        if(isHost && !timerInterval){
            timerInterval=setInterval(()=>{
                db.ref('game/timeLeft').transaction(t=>t>0?t-1:0);
            },1000);
        }

        if(g.timeLeft<=3) navigator.vibrate?.(150);
    }

    if(g.status==='finished'){
        go('view-result');
        db.ref('players').once('value',s=>{
            let html="";
            const p=s.val()||{};
            Object.entries(p).sort((a,b)=>b[1]-a[1])
            .forEach(([n,sc],i)=>{
                html+=`${i+1}. ${n}ï¼š${sc}åˆ†<br>`;
            });
            result-list.innerHTML=html;
        });
    }
});

/* ===== Timer ===== */
db.ref('game/timeLeft').on('value',s=>{
    if(s.exists()) timer.innerText=s.val();
});

/* ===== Submit ===== */
function submit(ans){
    db.ref('game').once('value',s=>{
        const g=s.val();
        if(g.winner)return;
        if(ans.toUpperCase()===g.qs[g.idx].answer){
            db.ref('game/winner').transaction(w=>{
                if(w)return;
                return myName;
            },(_,ok)=>{
                if(ok) db.ref('players/'+myName)
                    .transaction(v=>(v||0)+10);
            });
        }else{
            feedback.innerText="âŒ éŒ¯èª¤";
            setTimeout(()=>feedback.innerText="",1200);
        }
    });
}
</script>
</body>
</html>
